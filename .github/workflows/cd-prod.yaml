name: CD - Deploy to Production

on:
  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Docker image tag to deploy to production'
        required: true
        type: string

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://gitops-demo.local
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update production image tag
        run: |
          cd k8s/overlays/prod
          yq eval '.images[0].newTag = "${{ inputs.image-tag }}"' -i kustomization.yaml

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/overlays/prod/kustomization.yaml
          git commit -m "Deploy to production: ${{ inputs.image-tag }}

          ðŸš€ Production deployment

          Co-Authored-By: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
          git push

      - name: Create deployment record
        run: |
          echo "Deployment to production completed"
          echo "Image tag: ${{ inputs.image-tag }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting for ArgoCD to sync the changes..."
          echo "Monitor ArgoCD UI for deployment status"
          echo "Verify health checks after deployment"
